<?php
require(ROOT_PATH . '/app/memberseller.app.php');

class Seller_adminIndexApp extends MembersellerApp
{
    protected $_store_mod;

    public function __construct()
    {
        $this->Seller_adminApp();
    }

    public function Seller_adminApp()
    {
        parent::__construct();
        $this->_get_member_role();
        $this->_store_mod = & m('store');
    }

    public function index()
    {
        $user = $this->visitor->get();

        $user_mod = & m('member');

        $this->_curlocal(LANG::get('member_center'),    url('app=member'),
            LANG::get('overview'));

        /* 当前用户中心菜单 */
        $this->_curitem('overview');
        $this->_config_seo('title', Lang::get('member_center'));

        if(IS_POST)
        {
            $data['store_name'] = $_POST['store_name'];
            $data['storemail']       = $_POST['email'];
            $data['region_id']  = $_POST['region_id'];
            $data['region_name'] = $_POST['region_name'];
            $data['address']     = $_POST['address'];
            $data['lxrname']     = $_POST['lxrname'];
            $data['sectname']    = $_POST['sectname'];
            $data['tel']         = $_POST['tel'];
            $data['phone']      = $_POST['phone'];

            $this->_store_mod->edit($user['user_id'],$data);

        }

        $region_mod = & m('region');
        $this->assign('regions',$region_mod->get_options(0));

        $store = $this->_store_mod->get_info($user['user_id']);
        $this->assign('store',$store);



        $this->import_resource(
            array('script'=>'jquery.plugins/jquery.validate.js')
        );


        $this->display('buyer.index.html');
    }
    /*
     * 商家认证
     */
    public function approve()
    {
        $user = $this->visitor->get();

        $this->_curlocal(LANG::get('member_center'),    url('app=member'),
            LANG::get('overview'));

        /* 当前用户中心菜单 */
        $this->_curitem('my_profile');
        $this->_config_seo('title', Lang::get('member_center'));

        if(IS_POST)
        {
            $images = array('img_license');
            $image_urls = $this->_uplocad_images($images);
            foreach($images as $image)
            {
                $data[$image] = $image_urls[$image];
            }
            $this->_store_mod->edit($user['user_id'],$data);
        }

        $store = $this->_store_mod->get_info($user['user_id']);

        $this->assign('store',$store);
        $this->display('buyer.approve.html');
    }

    /*
     * 安全
     */
   public function security()
   {
       parent::security(); // TODO: Change the autogenerated stub
   }


    public function _get_member_role()
    {
        if (!$this->visitor->has_login)
        {
            header('Location:index.php?app=member&act=login&ret_url=' . rawurlencode($_SERVER['PHP_SELF'] . '?' . $_SERVER['QUERY_STRING']));
            return;
        }
        if(!$this->visitor->get('has_store')){
            $this->show_warning('has_no_store');
            exit;
        }
        $_SESSION['member_role'] = 'seller_admin';
    }

    public  function _uplocad_images($images)
    {
        import('uploader.lib');
        $image_urls = array();

        foreach ($images as $image)
        {
            $file = $_FILES[$image];
            if ($file['error'] != UPLOAD_ERR_OK)
            {
                continue;
            }
            $uploader = new Uploader();
            $uploader->allowed_type(IMAGE_FILE_TYPE);
            $uploader->addFile($file);
            if ($uploader->file_info() === false)
            {
                continue;
            }
            $uploader->root_dir(ROOT_PATH);
            $image_urls[$image] = $uploader->save(UPLOAD_PATH_BUS , $image);
        }
        return $image_urls;
    }



}


?>